clear all;

P = [
  -0.04771404380169175   0.00257260067715137   0.99997904539760862;
  -2.20702079871975165   0.33962521215663077   0.98690840138259572;
  -3.18176610773422031   0.56909283644128217   0.97365438638906532;
  -1.78025009547461521   0.01527811562077360   1.02835957778822529;
  -0.41649699831392845  -0.68307892358822708   1.11776116158593219;
   0.38922634110370402  -1.19353556168153307   1.19860415502070383;
   0.74374119036299269  -1.46110851560422139   1.24908705643443918;
   0.83052079236018483  -1.53654467642641879   1.26547468288957599;
   0.78800718843279349  -1.49295585715799861   1.25430436100060683;
   0.69501218694431410  -1.38733415684937089   1.22431374908326918;
   0.59194552317321070  -1.25773945966751621   1.18357607312715163;
   0.49603211355449717  -1.12534769681107383   1.13789014900586238;
   0.41310653663000840  -1.00065238343444585   1.09101405190829737;
   0.34387423750160129  -0.88799265390346627   1.04518210519920185;
   0.28702242401070127  -0.78844850749900541   1.00160816878923331;
   0.24065007648894654  -0.70151589420069427   0.96086581771174773];

phi = 0.234;
x = cos(phi);
y = sin(phi);

% preconditioning
negate = (y < 0);
x = abs(x);
y = abs(y);
invert = (y < x);

t = abs(log2(y/x));
g = 1/(1+t);

% extract piecewise polynomial index and evaluate
i = floor(g*16)+1;
p = P(i,:);

phi_hat = polyval(p,g)*pi/2;

if invert,
    phi_hat = pi/2 - phi_hat;
end;

if negate,
    phi_hat = -phi_hat;
end;

phi
phi_hat

